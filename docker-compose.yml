version: "3.5"

services:
  mosquitto:
    image: eclipse-mosquitto:latest
    command: mosquitto -c /mosquittoconf/mosquitto.conf
    ports:
      - 1883:1883
      - 9001:9001
    volumes:
      - ./mosquitto:/mosquittoconf
    restart: unless-stopped
    networks:
      - traefik
    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.mosquitto-websocket.rule=Host(`mqtt.${DOMAIN:-gregstretton.org}`)"
      - "traefik.http.routers.mosquitto-websocket.entrypoints=websecure"
      - "traefik.http.routers.mosquitto-websocket.tls=true"
      - "traefik.http.routers.mosquitto-websocket.tls.certresolver=myresolver"

      # Add a service for WebSocket traffic
      - "traefik.http.services.mosquitto-websocket.loadbalancer.server.port=9001"

       # TCP Router for MQTT
      - "traefik.tcp.routers.mqtt-router.rule=HostSNI(`mqtt.${DOMAIN:-gregstretton.org}`)"
      - "traefik.tcp.routers.mqtt-router.entrypoints=mqttsecure"
      - "traefik.tcp.routers.mqtt-router.tls=true"
      - "traefik.tcp.routers.mqtt-router.tls.certresolver=myresolver"
      - "traefik.tcp.routers.mqtt-router.service=mosquitto"
      - "traefik.tcp.services.mosquitto.loadbalancer.server.port=1883"
  interface:
    image: gkstretton/asol-dev-interface:latest
    ports:
      - 8085:80
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.asol-dev-interface.rule=Host(`asol.${DOMAIN:-gregstretton.org}`)"
      - "traefik.http.routers.asol-dev-interface.entrypoints=web,websecure"
      - "traefik.http.routers.asol-dev-interface.tls=true"
      - "traefik.http.routers.asol-dev-interface.tls.certresolver=myresolver"
    networks:
      - traefik

  mediamtx:
    image: aler9/rtsp-simple-server
    restart: unless-stopped
    networks:
      - traefik
    ports:
      - 8889:8889
    volumes:
      - ./mediamtx/mediamtx.yml:/rtsp-simple-server.yml
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.webrtc-websocket.rule=Host(`webrtc.${DOMAIN:-gregstretton.org}`)"
      - "traefik.http.routers.webrtc-websocket.entrypoints=websecure"
      - "traefik.http.routers.webrtc-websocket.tls=true"
      - "traefik.http.routers.webrtc-websocket.tls.certresolver=myresolver"
      - "traefik.http.services.webrtc-websocket.loadbalancer.server.port=8889"

networks:
  traefik:
    name: traefik_network